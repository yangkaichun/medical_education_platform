<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>衛教影片網站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet"/>
  <!-- Google Fonts (Noto Sans TC) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Noto Sans TC', Arial, sans-serif;
      background-color: #f9fafb;
      min-height: 100vh;
    }
    .hidden-file-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
      z-index: -10;
    }
    /* 禁用快進快退按鈕 */
    video::-webkit-media-controls {
      overflow: hidden !important;
    }
    video::-webkit-media-controls-enclosure {
      width: calc(100% + 30px);
      margin-left: -15px;
    }
    video::-webkit-media-controls-timeline,
    video::-webkit-media-controls-current-time-display,
    video::-webkit-media-controls-time-remaining-display,
    video::-webkit-media-controls-seek-back-button,
    video::-webkit-media-controls-seek-forward-button {
      display: none !important;
    }
    video:fullscreen::-webkit-media-controls-panel {
      display: none !important;
    }
    /* Safari 專用 */
    video::-webkit-media-controls-play-button {}
    /* Firefox 禁用進度條 */
    video::-moz-media-controls {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <div class="max-w-xl mx-auto mt-6 mb-10 p-6 bg-white shadow-lg rounded-xl w-full">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-900">衛教影片觀看與問卷填寫</h1>
    <!-- QR Code 掃描區 -->
    <form id="start-form" class="flex flex-col space-y-4">
      <div>
        <label for="qr-code" class="block text-gray-700 mb-1 font-semibold">QR Code掃描結果</label>
        <div class="flex">
          <input id="qr-code" name="qr-code" type="text" placeholder="請掃描或輸入代碼" readonly
             class="flex-1 rounded-l-md border border-gray-300 focus:outline-none px-3 py-2 bg-gray-100 text-gray-700" required>
          <button type="button" id="scan-qr-btn"
            class="inline-flex items-center px-4 py-2 bg-blue-700 text-white rounded-r-md border-l-0 border border-blue-700 hover:bg-blue-800 focus:outline-none">
            <i class="fa-solid fa-qrcode mr-2"></i>
            掃描
          </button>
        </div>
        <!-- 隱藏拍照上傳QR IMAGE，可用作 Fallback (可選，預設隱藏) -->
        <input type="file" id="qr-file" accept="image/*" capture="environment" class="hidden-file-input">
      </div>

      <!-- QR掃描視圖/Modal -->
      <div id="qr-modal" class="fixed z-40 inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-5 flex flex-col items-center max-w-xs w-full">
          <video id="qr-video" playsinline class="w-full h-48 bg-black rounded-md mb-4"></video>
          <button id="close-qr-modal"
            class="px-4 py-2 bg-red-600 text-white rounded-lg mt-2 hover:bg-red-700 focus:outline-none">
            關閉
          </button>
        </div>
      </div>

      <!-- 主題選擇 -->
      <div>
        <label class="block text-gray-700 mb-1 font-semibold">選擇衛教主題</label>
        <div id="topic-container" class="grid grid-cols-3 gap-2">
          <!-- JS 產生主題選項（1-30） -->
        </div>
      </div>
      <button type="submit"
        class="w-full py-2 bg-blue-700 text-white font-semibold rounded-lg mt-4 hover:bg-blue-800 transition-colors duration-100"
        id="start-btn" disabled>
        送出並觀看影片
      </button>
    </form>

    <!-- 影片區域 -->
    <div id="video-section" class="hidden flex flex-col items-center mt-8">
      <h2 class="text-lg font-bold mb-3 text-gray-900" id="video-title">衛教影片</h2>
      <video id="health-video"
        width="100%"
        class="w-full rounded-lg border-2 border-blue-300"
        controls
        playsinline
        webkit-playsinline
        preload="metadata"
        >
        <source id="video-source" src="" type="video/mp4">
        您的瀏覽器不支援影片播放。
      </video>
      <button id="replay-btn" class="hidden mt-3 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-900">
        <i class="fa-solid fa-rotate-right mr-2"></i>重播
      </button>
    </div>

    <!-- 問卷區 -->
    <form id="quiz-form" class="hidden mt-8">
      <h2 class="text-lg font-bold mb-3 text-gray-900">請完成衛教問卷</h2>
      <div id="quiz-questions" class="space-y-4 mb-4"></div>
      <button type="submit"
        class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg mt-2 hover:bg-green-700 transition-colors"
        id="quiz-submit-btn">送出問卷</button>
    </form>

    <!-- 完成訊息 -->
    <div id="finish-message" class="hidden mt-6 flex flex-col items-center">
      <i class="fa-solid fa-circle-check text-green-500 text-3xl mb-2"></i>
      <h3 class="text-green-700 font-bold text-xl mb-2">問卷填畢</h3>
      <p class="text-gray-800 text-center">您已完成本次衛教活動。<br>已通知護理師協助您後續說明。</p>
    </div>
  </div>

  <!-- jsQR 庫 -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <!-- 全域變數與假資料產生(設定與問卷) -->
  <script>
    // 預設30主題及影片MP4網址，實際請改以 github api 拉設定
    const DEFAULT_TOPICS = Array.from({length:30}, (_,i)=> ({
      id: i+1,
      name: `衛教主題${i+1}`,
      video: `videos/health${i+1}.mp4`
    }));
    // 問卷假資料，每題3題(可用github api存取)
    const DEFAULT_QUIZZES = Object.fromEntries(
      DEFAULT_TOPICS.map(topic => [
        topic.id,
        [
          { id: 1, type:'boolean', question:'請問這部影片內容您清楚嗎？', score:1 },
          { id: 2, type:'choice', question:'本主題主要是預防哪一項疾病？', options:['A. 糖尿病','B. 高血壓','C. 骨質疏鬆'], answer:0, score:2 },
          { id: 3, type:'boolean', question:'您是否願意配合本次衛教內容實踐？', score:1 }
        ]
      ])
    );
    // 偵測本地有無github sync設定
    let githubToken = localStorage.getItem("github_token")||null;
    let repoName = localStorage.getItem("github_repo")||null;
    // 正式可用 github api 拉主題設定 及問卷
    let topics = DEFAULT_TOPICS;
    let quizzes = DEFAULT_QUIZZES;
  </script>
  <!-- 主邏輯JS -->
  <script>
    const qrBtn = document.getElementById('scan-qr-btn');
    const qrCodeInput = document.getElementById('qr-code');
    const qrModal = document.getElementById('qr-modal');
    const qrVideo = document.getElementById('qr-video');
    const closeQrModalBtn = document.getElementById('close-qr-modal');
    const qrFileEl = document.getElementById('qr-file');
    const topicContainer = document.getElementById('topic-container');
    const startForm = document.getElementById('start-form');
    const startBtn = document.getElementById('start-btn');
    const videoSection = document.getElementById('video-section');
    const videoTitle = document.getElementById('video-title');
    const videoElem = document.getElementById('health-video');
    const videoSource = document.getElementById('video-source');
    const replayBtn = document.getElementById('replay-btn');
    const quizForm = document.getElementById('quiz-form');
    const quizQuestions = document.getElementById('quiz-questions');
    const quizSubmitBtn = document.getElementById('quiz-submit-btn');
    const finishMessage = document.getElementById('finish-message');

    // 動態注入主題選擇
    function buildTopicOptions(){
      topics.forEach(topic=>{
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-2 bg-gray-100 hover:bg-blue-100 p-1 rounded-md cursor-pointer border border-gray-300';
        label.innerHTML = `
          <input type="radio" required name="topic" value="${topic.id}" class="h-4 w-4 text-blue-600 focus:ring-2">
          <span class="text-sm select-none">${topic.name}</span>
        `;
        topicContainer.appendChild(label);
      });
    }
    buildTopicOptions();

    // 開始送出按鈕啟用條件
    startForm.addEventListener('input', ()=>{
      startBtn.disabled = !(qrCodeInput.value.trim().length && startForm.topic.value);
    });

    // --  QR Code 掃描區域 --
    let qrStream = null;
    let qrScanActive = false;

    qrBtn.addEventListener('click', ()=>openQrModal());

    closeQrModalBtn.addEventListener('click', ()=>{
      closeQrModal();
    });

    function openQrModal(){
      qrModal.classList.remove('hidden');
      startQRScan();
    }
    function closeQrModal(){
      qrModal.classList.add('hidden');
      stopQRScan();
    }
    function stopQRScan(){
      qrScanActive = false;
      if(qrStream){
        qrStream.getTracks().forEach(track => track.stop());
        qrVideo.srcObject = null;
      }
    }
    function startQRScan(){
      qrScanActive = true;
      navigator.mediaDevices.getUserMedia({ video: {facingMode: 'environment'} })
        .then(stream=>{
          qrStream = stream;
          qrVideo.srcObject = stream;
          qrVideo.setAttribute('playsinline', 'true');
          qrVideo.play();
          requestAnimationFrame(tickQRScan);
        }).catch(()=>{
          alert('無法存取攝影機，請檢查瀏覽器權限');
          closeQrModal();
        });
    }
    function tickQRScan(){
      if(!qrScanActive) return;
      if(qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA){
        const canvas = document.createElement('canvas');
        canvas.width = qrVideo.videoWidth;
        canvas.height = qrVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(qrVideo,0,0,canvas.width,canvas.height);
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if(code){
          qrCodeInput.value = code.data;
          closeQrModal();
          startBtn.disabled = !(qrCodeInput.value.trim().length && startForm.topic.value);
          return;
        }
      }
      requestAnimationFrame(tickQRScan);
    }
    // fallback: 點下輸入框支援手動上傳圖片檔
    qrCodeInput.addEventListener('click', ()=> qrFileEl.click());
    qrFileEl.addEventListener('change', e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const img = new window.Image();
        img.onload = function(){
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if(code) {
            qrCodeInput.value = code.data;
            startBtn.disabled = !(qrCodeInput.value.trim().length && startForm.topic.value);
            alert('QR已擷取成功');
          } else {
            alert('QR碼辨識失敗');
          }
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // --  開始進入影片  --
    let selectedTopicId = null;
    let qrCodeValue = null;
    startForm.addEventListener('submit', e=>{
      e.preventDefault();
      qrCodeValue = qrCodeInput.value.trim();
      selectedTopicId = parseInt(startForm.topic.value);
      // 顯示影片
      showVideoSection(selectedTopicId);
    });

    function showSection(section){
      [startForm, videoSection, quizForm, finishMessage].forEach(d=>d.classList.add('hidden'));
      section.classList.remove('hidden');
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // 影片播放區域
    function showVideoSection(topicId){
      const topic = topics.find(t=>t.id==topicId);
      videoTitle.textContent = topic.name;
      videoSource.src = topic.video;
      videoElem.load();
      showSection(videoSection);
      replayBtn.classList.add('hidden');
      videoElem.controls = true;
      disableSeek(videoElem);
      videoElem.currentTime = 0;
      videoElem.play();
      // 記錄觀看起始時間
      window.__videoStartTime = Date.now();
    }
    // 禁止快轉
    function disableSeek(vid){
      vid.addEventListener('seeking', function lockSeek(e){
        if(Math.abs(vid.currentTime - vid.lastAllowedTime || 0)>0.5){
          // 強制拉回
          vid.currentTime = vid.lastAllowedTime||0;
        }
      });
      vid.addEventListener('timeupdate', function saveCurr(){
        vid.lastAllowedTime = vid.currentTime;
      });
      // 移除控制條 seekbar
      setTimeout(()=>{
        const controls = vid.parentElement.querySelectorAll("input[type=range], .seekbar, .vjs-progress-control");
        controls.forEach(ctrl=>ctrl.style.display = 'none');
      }, 500);
    }

    // 影片播放完畢
    videoElem.addEventListener('ended', ()=>{
      replayBtn.classList.remove('hidden');
      showQuizForm(selectedTopicId);
    });
    // 支援重播
    replayBtn.addEventListener('click', ()=>{
      videoElem.currentTime = 0;
      videoElem.play();
    });

    // -- 問卷區域 --
    function showQuizForm(topicId){
      showSection(quizForm);
      renderQuizQuestions(topicId);
    }
    function renderQuizQuestions(topicId){
      quizQuestions.innerHTML = '';
      const qz = quizzes[topicId]||[];
      qz.forEach((q,i)=>{
        let html = `<div class="mb-2"> <span class="font-semibold">${i+1}. ${q.question}</span><br>`;
        if(q.type=='boolean'){
          html += `
            <label class="mr-4"><input type="radio" name="q_${q.id}" value="1" required class="mr-1"> 是</label>
            <label><input type="radio" name="q_${q.id}" value="0" required class="mr-1"> 否</label>
          `;
        } else if(q.type==='choice') {
          html += `<select name="q_${q.id}" required class="border rounded px-2 py-1 ml-1">`;
          (q.options||[]).forEach((opt, idx)=>{
            html += `<option value="${idx}">${opt}</option>`;
          });
          html += `</select>`;
        }
        html += '</div>';
        quizQuestions.innerHTML += html;
      });
    }

    quizForm.addEventListener('submit', e=>{
      e.preventDefault();
      // 計分
      const formData = new FormData(quizForm);
      const qz = quizzes[selectedTopicId]||[];
      let score = 0;
      qz.forEach(q=>{
        if(q.type=='boolean'){
          score += (formData.get(`q_${q.id}`)=='1') ? q.score: 0;
        } else if(q.type=='choice'){
          score += (parseInt(formData.get(`q_${q.id}`)) == (q.answer||0)) ? q.score: 0;
        }
      });
      // 儲存結果(localStorage，或推github)
      saveResult({
        code: qrCodeValue,
        topicId: selectedTopicId,
        topicName: topics.find(t=>t.id==selectedTopicId).name,
        video: topics.find(t=>t.id==selectedTopicId).video,
        watched: true,
        finished: true,
        score: score,
        answers: Object.fromEntries([...formData]),
        time: new Date().toISOString(),
        duration: ((Date.now()-window.__videoStartTime)/1000).toFixed(1) //秒
      });
      showSection(finishMessage);
    });

    // 儲存問卷結果 (可改存github)
    function getResults(){
      return JSON.parse(localStorage.getItem('health_quiz_result')||'[]');
    }
    function saveResult(obj){
      let arr = getResults();
      arr.push(obj);
      localStorage.setItem('health_quiz_result', JSON.stringify(arr));
    }
  </script>
</body>
</html>

    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDnIIZvy7Huo3UpXmvy27nBhPsDTZGaNmhvWYZqGXaGQQ%2Ba3EPiB3KyR%2Bxeidy6DIki9aldpnYjtPF2AEYuttjkTJ%2Fzxz%2Ft1Npj6tF4zGQBxdz6KAWh%2ByAaDMy5PnjFDdiMJ6PZEwO2WXcDq2K6gG49DkS9bdcjubWokpWWcRXnVH%2FX4yG1RdRtCqgocGE2IyTdTPvl536L9LSEEYJYB%2BZJ3Uruq3nseKQUKiZFMqOby8hlxCZDVcT1TSmQgs0eo0mrWoO9n4%2FVSQ6gBDQyoYmnJcs%2B%2FwazZzWJ3cG5AjeeSIrk8S9yX2WAFUqtxHX7JIw%2B2cfTSwqiDF%2Bb6%2BAoCfZjzz%2BwEteWu4fsWRtWDo%2BhaMMb0BH5i8nMdc2Ia%2BupC%2BaBkc9uM9UwuPvmCWvMnfRhPRYH8eUJYzc55n%2BvGisdp%2FXLfcloskyS8GDKeXpWBQMcZBvdiZaKH4FlTZm6EW9k9PqFcJCa9W%2Bux1NAuK1t9E";
        window.__genspark_locale = "zh-TW";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDnIIZvy7Huo3UpXmvy27nBhPsDTZGaNmhvWYZqGXaGQQ+a3EPiB3KyR+xeidy6DIki9aldpnYjtPF2AEYuttjkTJ/zxz/t1Npj6tF4zGQBxdz6KAWh+yAaDMy5PnjFDdiMJ6PZEwO2WXcDq2K6gG49DkS9bdcjubWokpWWcRXnVH/X4yG1RdRtCqgocGE2IyTdTPvl536L9LSEEYJYB+ZJ3Uruq3nseKQUKiZFMqOby8hlxCZDVcT1TSmQgs0eo0mrWoO9n4/VSQ6gBDQyoYmnJcs+/wazZzWJ3cG5AjeeSIrk8S9yX2WAFUqtxHX7JIw+2cfTSwqiDF+b6+AoCfZjzz+wEteWu4fsWRtWDo+haMMb0BH5i8nMdc2Ia+upC+aBkc9uM9UwuPvmCWvMnfRhPRYH8eUJYzc55n+vGisdp/XLfcloskyS8GDKeXpWBQMcZBvdiZaKH4FlTZm6EW9k9PqFcJCa9W+ux1NAuK1t9E";
    </script>
    