<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>衛教影片管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS 2.2.19 -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome 6.5.2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" />
  <!-- Google Fonts (Noto Sans TC) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <!-- Chart.js 4.4.3 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif;}
    .fade-in { animation: fadein 0.4s; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
    .admin-scroll::-webkit-scrollbar { width: 8px; background: #edf2f7;}
    .admin-scroll::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 5px;}
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-blue-800 text-white shadow py-4 px-4 md:px-8 flex justify-between items-center">
    <h1 class="text-2xl font-bold tracking-wide"><i class="fa-solid fa-film mr-2"></i>衛教影片管理後台</h1>
    <button id="emailSettingBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 transition text-white"><i class="fa-solid fa-envelope"></i> 郵件通知設定</button>
  </header>

  <main class="flex-1 container mx-auto py-6 px-2 md:px-8">
    <!-- 概覽區塊 -->
    <div class="flex flex-wrap space-y-2 md:space-y-0 md:space-x-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4 flex-1 flex flex-col items-center">
        <div class="text-gray-700 text-lg"><i class="fa-solid fa-list-check text-blue-500"></i> 問卷總數</div>
        <div class="text-2xl font-bold" id="totalSurveyCount">0</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4 flex-1 flex flex-col items-center">
        <div class="text-gray-700 text-lg"><i class="fa-solid fa-play-circle text-green-500"></i> 目前觀看中</div>
        <div class="text-2xl font-bold" id="watchingCount">0</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4 flex-1 flex flex-col items-center">
        <div class="text-gray-700 text-lg"><i class="fa-solid fa-check-circle text-yellow-500"></i> 已完成填答</div>
        <div class="text-2xl font-bold" id="finishedCount">0</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4 flex-1 flex flex-col items-center">
        <div class="text-gray-700 text-lg"><i class="fa-solid fa-envelope-circle-check text-indigo-500"></i> 已通知護理師</div>
        <div class="text-2xl font-bold" id="notifiedCount">0</div>
      </div>
    </div>

    <!-- 觀看狀態區塊 -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex items-center mb-2">
        <i class="fa-solid fa-tv mr-2 text-pink-600"></i>
        <span class="text-lg font-bold text-pink-600">目前使用者即時觀看情形</span>
      </div>
      <div id="realtimeStatusList" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- 問卷結果表格 -->
    <div class="bg-white rounded-lg shadow p-4 admin-scroll">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-table text-blue-400"></i>
          <span class="font-bold text-lg">問卷結果列表</span>
        </div>
        <div><span id="lastUpdated" class="text-gray-500 text-xs"></span></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-gray-800">
          <thead>
            <tr class="bg-gray-100 text-gray-700">
              <th class="px-2 py-1">QR Code代碼</th>
              <th class="px-2 py-1">衛教主題</th>
              <th class="px-2 py-1">影片狀態</th>
              <th class="px-2 py-1">問卷分數</th>
              <th class="px-2 py-1">護理師已知曉</th>
              <th class="px-2 py-1">觀看時間</th>
              <th class="px-2 py-1">操作</th>
            </tr>
          </thead>
          <tbody id="resultList">
          </tbody>
        </table>
      </div>
      <!-- 分頁區佔位 -->
    </div>

    <!-- 問卷分數統計圖表 -->
    <div class="bg-white rounded-lg shadow p-4 mt-6">
      <div class="flex items-center mb-2">
        <i class="fa-solid fa-chart-bar text-cyan-600 mr-2"></i>
        <span class="text-lg font-bold text-cyan-600">問卷分數分布</span>
      </div>
      <canvas id="scoreChart" height="60"></canvas>
    </div>
  </main>

  <!-- Email 設定Modal -->
  <div id="emailSettingModal" class="hidden fixed inset-0 z-30 flex justify-center items-center bg-black bg-opacity-40 fade-in">
    <div class="bg-white w-full max-w-md rounded-lg shadow-xl p-6">
      <div class="flex items-center mb-3">
        <i class="fa-solid fa-envelope-open-text mr-2 text-blue-600"></i>
        <span class="text-lg font-bold">通知護理師Email設定</span>
      </div>
      <form id="emailForm" class="space-y-3">
        <template id="emailRowTpl">
          <div class="flex items-center gap-2 mb-1">
            <input type="email" class="email-input border rounded px-2 py-1 flex-1" required placeholder="請輸入Email" />
            <label class="flex items-center text-sm text-gray-700 font-medium"><input type="checkbox" class="enable-checkbox mr-1" checked>啟用</label>
            <button type="button" class="del-email-btn text-red-500 hover:text-red-700" title="刪除"><i class="fa-solid fa-trash"></i></button>
          </div>
        </template>
        <div id="emailListRows"></div>
        <button type="button" id="addEmailBtn" class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600"><i class="fa-solid fa-plus"></i> 新增</button>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancelEmailSettingBtn" class="px-4 py-2 bg-gray-300 rounded text-gray-700 hover:bg-gray-400">取消</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 rounded text-white hover:bg-blue-700"><i class="fa-solid fa-save"></i> 儲存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 刪除確認Modal -->
  <div id="deleteModal" class="hidden fixed inset-0 z-40 flex justify-center items-center bg-black bg-opacity-40 fade-in">
    <div class="bg-white rounded shadow-lg p-6 max-w-sm w-full flex flex-col">
      <div class="font-bold text-lg mb-3"><i class="fa-solid fa-triangle-exclamation text-red-600"></i> 確認刪除</div>
      <div class="mb-5 text-gray-700">確定要刪除此筆資料嗎？此動作無法還原。</div>
      <div class="flex gap-2 justify-end">
        <button id="cancelDeleteBtn" class="px-4 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300">取消</button>
        <button id="confirmDeleteBtn" class="px-4 py-1 rounded bg-red-500 text-white hover:bg-red-600">刪除</button>
      </div>
    </div>
  </div>

  <!-- 底部 -->
  <footer class="text-center text-gray-500 py-4 text-xs">
    Copyright © <span id="curYear"></span> 衛教影片系統 | 管理後台
  </footer>

  <!-- Script 區 -->
  <script>
    // --- 控制全局狀態 ---
    let surveyResults = [];
    let emailList = [];
    let chartInstance = null;
    let deleteRowIndex = null;
    let refreshTimer = null;

    // --- 工具函式 ---
    function fmtTime(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + ('0'+d.getHours()).slice(-2) + ':' + ('0'+d.getMinutes()).slice(-2);
    }

    function saveData() {
      localStorage.setItem('surveyResults', JSON.stringify(surveyResults));
    }
    function loadData() {
      try {
        surveyResults = JSON.parse(localStorage.getItem('surveyResults')) || [];
      } catch (e) { surveyResults = [];}
    }
    function saveEmails() {
      localStorage.setItem('nurseEmails', JSON.stringify(emailList));
    }
    function loadEmails() {
      try {
        emailList = JSON.parse(localStorage.getItem('nurseEmails')) || [];
      } catch (e) {emailList=[];}
    }

    function shuffle(arr) {
      return arr.map(v => [v, Math.random()]).sort((a,b)=>a[1]-b[1]).map(v=>v[0]);
    }

    // --- 表格渲染 ---
    function renderTable() {
      // 以觀看時間 desc 排序
      surveyResults.sort((a, b) => (b.watchTime || 0) - (a.watchTime || 0));
      let html = '';
      for (let [i, row] of surveyResults.entries()) {
        html += `<tr class="hover:bg-gray-50 transition">
            <td class="px-2 py-1">${row.qrCode || ''}</td>
            <td class="px-2 py-1">${row.topic || ''}</td>
            <td class="px-2 py-1">
              ${row.state === 'watching' ? '<span class="text-yellow-600 font-bold">觀看中</span>' :
                row.state === 'finished' ? '<span class="text-green-600 font-bold">已完成</span>' : 
                '<span class="text-gray-500">-</span>'}
            </td>
            <td class="px-2 py-1">${row.score !== undefined ? row.score : '-'}</td>
            <td class="px-2 py-1 flex items-center gap-1 justify-center">${row.notified?
                '<i class="fa-solid fa-check text-green-600"></i>':'<i class="fa-solid fa-xmark text-gray-400"></i>'}
                <button data-idx="${i}" class="toggle-notify-btn text-sm text-blue-600 hover:underline">${row.notified?'已通知':'通知'}</button>
            </td>
            <td class="px-2 py-1">${fmtTime(row.watchTime)}</td>
            <td class="px-2 py-1">
              <button data-idx="${i}" class="delete-btn text-red-500 hover:text-red-700" title="刪除"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>`;
      }
      document.getElementById('resultList').innerHTML = html;
      document.getElementById('lastUpdated').innerText = '更新時間: ' + fmtTime(Date.now());
      // 根據狀態統計
      document.getElementById('totalSurveyCount').innerText = surveyResults.length;
      document.getElementById('watchingCount').innerText = surveyResults.filter(r => r.state === 'watching').length;
      document.getElementById('finishedCount').innerText = surveyResults.filter(r => r.state === 'finished').length;
      document.getElementById('notifiedCount').innerText = surveyResults.filter(r => r.notified).length;
    }

    // --- 畫 chart ---
    function renderScoreChart() {
      if (chartInstance) { chartInstance.destroy(); }
      let buckets = [0,0,0,0,0,0];
      surveyResults.forEach(r=>{
        if(r.score===undefined) return;
        if(r.score>=90) buckets[5]++;
        else if(r.score>=80) buckets[4]++;
        else if(r.score>=70) buckets[3]++;
        else if(r.score>=60) buckets[2]++;
        else if(r.score>=50) buckets[1]++;
        else buckets[0]++;
      });
      chartInstance = new Chart(document.getElementById('scoreChart'), {
        type: 'bar',
        data: {
          labels: ['<50','50~59','60~69','70~79','80~89','90+'],
          datasets: [{
            label: '人數',
            data: buckets,
            backgroundColor: [
              '#e53e3e', '#f6ad55', '#ecc94b', '#68d391', '#63b3ed','#805ad5'
            ]
          }]
        },
        options: {
          plugins:{
            legend:{display:false}
          },
          scales:{
            x:{ title:{ display:true, text:'分數區間'} },
            y:{ beginAtZero:true, title:{display:true, text:'人數'} }
          }
        }
      });
    }

    // --- 觀看狀態 ---
    function renderRealtimeStatus() {
      let statusArr = surveyResults
        .filter(r=>r.state==='watching' || r.state==='finished')
        .map(r=>{
          return `<div class="bg-gradient-to-r from-blue-100 to-blue-50 px-3 py-2 rounded flex items-center gap-2 shadow">
            <i class="fa-solid fa-id-badge text-indigo-400"></i> 
            <span class="font-bold">${r.qrCode||'--'}</span>
            <span class="text-xs text-gray-500">/ 主題: ${r.topic||'-'}</span>
            <span class="text-xs ${r.state==='watching'?'text-yellow-600':'text-green-600'}">
              ${r.state==='watching'?'觀看中':'完成'}
            </span>
          </div>`;
        });
      document.getElementById('realtimeStatusList').innerHTML = statusArr.length>0?statusArr.join(''):'<span class="text-gray-400">尚無即時資料</span>';
    }

    // --- Email Modal 控制 ---
    document.getElementById('emailSettingBtn').onclick=function(){
      loadEmails();
      renderEmails();
      document.getElementById('emailSettingModal').classList.remove('hidden');
    };
    document.getElementById('cancelEmailSettingBtn').onclick=function(){
      document.getElementById('emailSettingModal').classList.add('hidden');
    };
    function renderEmails() {
      const box = document.getElementById('emailListRows');
      box.innerHTML = '';
      emailList.forEach((eml,i)=>{
        let tpl = document.getElementById('emailRowTpl').content.cloneNode(true);
        tpl.querySelector('input[type="email"]').value = eml.email;
        tpl.querySelector('input[type="email"]').oninput = (e)=>{
          emailList[i].email = e.target.value;
          saveEmails();
        };
        tpl.querySelector('.enable-checkbox').checked = !!eml.enabled;
        tpl.querySelector('.enable-checkbox').onchange = (e)=>{
          emailList[i].enabled = e.target.checked;
          saveEmails();
        };
        tpl.querySelector('.del-email-btn').onclick = ()=>{
          emailList.splice(i,1);
          saveEmails();
          renderEmails();
        };
        box.appendChild(tpl);
      });
    }
    document.getElementById('addEmailBtn').onclick=function(){
      emailList.push({email:'', enabled:true});
      renderEmails();
    };
    document.getElementById('emailForm').onsubmit=function(e){
      e.preventDefault();
      saveEmails();
      document.getElementById('emailSettingModal').classList.add('hidden');
    };

    // --- 刪除功能 ---
    document.getElementById('resultList').onclick=function(e){
      if(e.target.closest('.delete-btn')) {
        deleteRowIndex = +e.target.closest('.delete-btn').dataset.idx;
        document.getElementById('deleteModal').classList.remove('hidden');
      }
      if(e.target.closest('.toggle-notify-btn')) {
        const idx = +e.target.closest('.toggle-notify-btn').dataset.idx;
        if (!surveyResults[idx].notified) {
          notifyNurse(idx, false);
        }
      }
    };
    document.getElementById('cancelDeleteBtn').onclick=function(){
      document.getElementById('deleteModal').classList.add('hidden');
    };
    document.getElementById('confirmDeleteBtn').onclick=function(){
      if(deleteRowIndex!==null) {
        surveyResults.splice(deleteRowIndex,1);
        saveData();
        renderTable(); renderScoreChart(); renderRealtimeStatus();
        deleteRowIndex=null;
      }
      document.getElementById('deleteModal').classList.add('hidden');
    };

    // --- 護理師Email通知邏輯 (模擬) ---
    function notifyNurse(idx, auto) {
      loadEmails();
      const enabledEmails = emailList.filter(e=>e.enabled && e.email);
      if (enabledEmails.length===0) {
        alert('尚未設定有效的護理師Email!');
        return;
      }
      // 實際應用時此處執行email API呼叫
      const row = surveyResults[idx];
      row.notified = true;
      saveData();
      renderTable();
      if (!auto) alert('結果已通知到：\n' + enabledEmails.map(e=>e.email).join('\n'));
    }

    // --- 啟動: 載入資料 ---
    function mainInit() {
      loadData();
      loadEmails();
      renderTable();
      renderScoreChart();
      renderRealtimeStatus();
      // Email通知自動: 如有新finished未通知者則立即通知
      const unfinishedToNotify = surveyResults.filter(r=>r.state==='finished' && !r.notified);
      unfinishedToNotify.forEach((r,idx)=>{
        notifyNurse(surveyResults.indexOf(r), true);
      });
      // 啟動自動刷新
      if(refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(()=>{
        loadData();
        loadEmails();
        renderTable();
        renderScoreChart();
        renderRealtimeStatus();
      }, 30000);
    }

    // --- 初始化 ---
    window.onload=mainInit;
    document.getElementById('curYear').innerText = new Date().getFullYear();
  </script>
</body>
</html>

    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDqMO4muuFziml1y%2Ffs%2Fbwdj%2BSqg8EnQ27Mrl4BzwCdno10HDCFClmaZr8Dy8%2Fzdo1Nr3ikGcPjNuuTOfdqupGLWoEzxU7TzKzG0XbOWJuoNBo5L7183DNvCTWnPQ0UEgR5M7TySZhGhdP5a0A67zJf0oxuI0612mHzuYLnE0ifNtzKvGwKLzeNasuqDqhhyW%2BFiA7xs0nUgEN4JtGbwABtxxc4B%2FZTTgQBaf5OYPQm0QtdEGw1yPFxdRXMh%2FIn3IGnPhZmg%2B3J3zoAbEzpZ2uL8IpvBzqwmiS4scrGwd4vs6%2FsrQx5206H%2FJ6SIM0cqJY%2F6jb1FUrCLzN53y7xx2xW3qyE4cpDDnFJx4vJa9j%2FH6FDJ%2BqGAQ07bzqVsdB7%2FtBXeNGfA8yIJwpCuKuZ73eAVForQ3Rf7n3L2OriQKmexTgctlqgFPdmcI6bEQ92EM7HBX%2FyBUFNutdzUILegipZF1tOEIdhco%2B1Vp8gIxTEw3";
        window.__genspark_locale = "zh-TW";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDqMO4muuFziml1y/fs/bwdj+Sqg8EnQ27Mrl4BzwCdno10HDCFClmaZr8Dy8/zdo1Nr3ikGcPjNuuTOfdqupGLWoEzxU7TzKzG0XbOWJuoNBo5L7183DNvCTWnPQ0UEgR5M7TySZhGhdP5a0A67zJf0oxuI0612mHzuYLnE0ifNtzKvGwKLzeNasuqDqhhyW+FiA7xs0nUgEN4JtGbwABtxxc4B/ZTTgQBaf5OYPQm0QtdEGw1yPFxdRXMh/In3IGnPhZmg+3J3zoAbEzpZ2uL8IpvBzqwmiS4scrGwd4vs6/srQx5206H/J6SIM0cqJY/6jb1FUrCLzN53y7xx2xW3qyE4cpDDnFJx4vJa9j/H6FDJ+qGAQ07bzqVsdB7/tBXeNGfA8yIJwpCuKuZ73eAVForQ3Rf7n3L2OriQKmexTgctlqgFPdmcI6bEQ92EM7HBX/yBUFNutdzUILegipZF1tOEIdhco+1Vp8gIxTEw3";
    </script>
    